<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="view_delivery_notice_form" model="ir.ui.view">
        <field name="name">delivery.notice.form</field>
        <field name="model">delivery.notice</field>
        <field name="arch" type="xml">
            <form string='notice'>
            	<header>
            		<button name='delivery_notice_done' states='draft' string='确认' type='object' class='oe_highlight'/>
            		<button name="delivery_notice_draft" states="done" string="撤销" type="object"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,done" readonly="1"/>
            	</header>
                <sheet>
                    <group>
                        <group>
                            <field name='custom_id' required='1'
                                domain="[('c_category_id', '!=', False)]"
                                options="{'no_open': True, 'no_create': True}"
                                />
                            <field name="date"/>
                            <field name="state"/>
                        </group>
                        <group>
                            <field name="express_type"/>
                            <field name="express_code"/>
                        </group>
                    </group>
                    <notebook>
                        <page name="lines" string="发货通知单行">
                            <field name='line_ids'>
                                <tree string='发货通知单行' editable='bottom'>
                                    <field name="sell_line_id"  domain="[('order_id.state','=','done'),
                                            ('order_id.partner_id','=',parent.custom_id)]"
                                           options="{'no_open': True, 'no_create': True}"/>
                                    <field name='goods_id' domain="[('not_sellable','=',False)]"/>
                                    <field name='attribute_id'/>
                                    <field name='qty'/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>  
    </record>

    <record id="view_delivery_notice_tree" model="ir.ui.view">
        <field name='name'>delivery.notice.tree</field>
        <field name="model">delivery.notice</field>
        <field name="arch" type="xml">
            <tree>
                <field name="date"/>
                <field name="custom_id"/>
                <field name="state"/>
            </tree> 
        </field> 
    </record>

    <record id="view_delivery_notice_filter" model="ir.ui.view">
        <field name='name'>delivery.notice.filter</field>
        <field name="model">delivery.notice</field>
        <field name="arch" type="xml">
            <search>
                <filter name="act_done" string="已确认" domain="[('state','=','done')]"/>
                <filter name="act_all" string="所有单据" domain="['|',('state','=','done'),('state','=','draft')]"/>
                <separator/>
                <filter string="今日数据" name="today" domain="[('date','=', current_date)]"/>
                <filter string="本月数据" name="month" domain="[('date','&gt;=', time.strftime('%Y-%m-01')),('date','&lt;',  (context_today() + relativedelta(months=1)).strftime('%Y-%m-01') ) ]"/>
                <filter string="上月数据" name="month2" domain="[('date','&lt;', time.strftime('%Y-%m-01')),('date','&gt;=',  (context_today() - relativedelta(months=1)).strftime('%Y-%m-01') ) ]"/>
                <filter string="本年数据" name="year" domain="[('date','&lt;=', time.strftime('%Y-12-31')),('date','&gt;=', time.strftime('%Y-01-01'))]"/>
                <field name="date" string="单据日期"/>
                <separator/>
                <field name="date"/>
                <field name="custom_id"/>
                <field name="express_type"/>
                <field name="express_code"/>
                <separator/>
                <group expand="0" string="分组">
                    <filter string="客户" name="group_custom_id" context="{'group_by':'custom_id'}" />
                    <filter string="确认状态" name="group_state" context="{'group_by':'state'}" />
                    <filter string="承运商" name="group_express_type" context="{'group_by':'express_type'}" />
                    <filter string="快递单号" name="group_express_code" context="{'group_by':'express_code'}" />
                </group>
            </search>
        </field>
    </record>

     <record id="action_delivery_notice" model="ir.actions.act_window">
        <field name="name">发货通知单</field>
        <field name="res_model">delivery.notice</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'search_default_month': 1}</field>
        <field name="search_view_id" ref="view_delivery_notice_filter"/>
        <field name="view_ids"
               eval="[(5, 0, 0),
                      (0, 0, {'view_mode': 'tree', 'view_id': ref('view_delivery_notice_tree')}),
                      (0, 0, {'view_mode': 'form', 'view_id': ref('view_delivery_notice_form')}),
                      ]"/>
         <field name="help" type="html">
            <p>
               发货通知单
            </p>
        </field>
    </record>

    <menuitem id="delivery_notice_menu"
        name="发货通知单"
        parent="sell.sell_order_menu_root"
        action="action_delivery_notice"
        sequence="1"
    />
    <!--扩展销售发货单页面通知信息-->
    <record id="view_sell_delivery_noticed_tree" model="ir.ui.view">
        <field name="name">sell.delivery.noticed.tree</field>
        <field name="model">sell.delivery</field>
        <field name="inherit_id" ref="sell.sell_delivery_tree" />
        <field name="arch" type="xml">
            <field name="state" position="after">
                <field name="noticed"/>
            </field>
        </field>
    </record>
    <record id="view_sell_delivery_noticed_form" model="ir.ui.view">
        <field name="name">sell.delivery.noticed.form</field>
        <field name="model">sell.delivery</field>
        <field name="inherit_id" ref="sell.sell_delivery_form" />
        <field name="arch" type="xml">
            <field name="warehouse_id" position="after">
                <field name="noticed" readonly="1"/>
            </field>
            <field name="goods_qty" position='after'>
                <field name="notice_line_id" invisible='1'/>
            </field>
            <field name="goods_qty" position="attributes">
                <attribute name="attrs">{'readonly': [('notice_line_id', '!=', False)]}</attribute>
            </field>
            <field name="goods_uos_qty" position="attributes">
                <attribute name="attrs">{'readonly': [('notice_line_id', '!=', False)]}</attribute>
            </field>
        </field>
    </record>
    <record id="view_sell_delivery_search" model="ir.ui.view">
        <field name="name">sell.delivery.noticed.search</field>
        <field name="model">sell.delivery</field>
        <field name="inherit_id" ref="sell.sell_delivery_search" />
        <field name="arch" type="xml">
            <filter name="done" position="after">
                <filter name="act_noticed" string="已通知" domain="[('noticed','=',True)]"/>
            </filter>
        </field>
    </record>
</odoo>